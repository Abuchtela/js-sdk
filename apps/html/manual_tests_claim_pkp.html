<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252" />
    <title>Manual Tests</title>

    <script src="/dist/packages/lit-node-client-vanilla/lit-node-client.js" type="application/javascript"></script>
    <script
      src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
      type="application/javascript"
    ></script>
    <script>
      window.exports = {};
      window.randomString = () =>
        Math.random().toString(36).substring(2, 15) +
        Math.random().toString(36).substring(2, 15);

        window.onload = () => {
          // set the email to something random so we can test over and over
          document.getElementById('email').value = `chris+${randomString()}@litprotocol.com`;
        }
    </script>
    <script src="/dist/packages/lit-auth-client-vanilla/lit-auth-client.js"> </script>
    <script type="module">
      import { StytchUIClient } from "https://cdn.jsdelivr.net/npm/@stytch/vanilla-js/dist/index.esm.js";

      window.LitJsSdk = LitJsSdk_litNodeClient;

      const litNodeClient = new LitNodeClient({
        litNetwork: 'cayenne',
        debug: true
      });
      litNodeClient.connect();

      const client = new StytchUIClient('public-token-live-8b3531cd-fd4b-4400-ae15-310fa8b659e2');

      var sendStytchOTP = async (email) => {
        const testName = 'Claim Stytch PKP';
        document.getElementById('status').innerText = `${testName}: Testing...`;

        window.stytchResponse = await client.otps.email.loginOrCreate(email, {
          expiration_minutes: 5,
        });

        document.getElementById('status').innerText = `${testName}: OTP Sent`;
      };

      const verifyAndClaimPKP = async (otp) => {
        console.log(`verifying otp: ${otp} with method id ${stytchResponse.method_id}`);

        const authSig = await LitJsSdk.checkAndSignAuthMessage({
          chain: "ethereum",
        });

        const authResponse = await client.otps.authenticate(otp, stytchResponse.method_id, {
          session_duration_minutes: 60,
          method_id: stytchResponse.method_id
        });
        console.log('authResponse: ', authResponse);

        let sessionResp = client.session.getSync();
        // let sessionResp = await client.sessions.get({
        //   user_id: authResponse.user_id
        // });

        const authClient = new LitAuthClient({
          litRelayConfig: {
              relayApiKey: "test_chris",
              relayUrl: "http://127.0.0.1:3001"
          },
          litNodeClient,
        });

        console.log('sessionResp: ', sessionResp);
        const session = authClient.initProvider('stytchOtp', {
          userId: sessionResp.user_id,
          appId: "project-live-4b70071a-da9c-46fb-8321-e29ab8cdc726",
        })

        console.log('authResponse.session_jwt: ', authResponse.session_jwt);
        console.log('session: ', session);

        const authMethod = await session.authenticate({ 
          accessToken:  authResponse.session_jwt
        });
        console.log('authMethod: ', authMethod);


        const claimResp = await session.claimKeyId({
          authMethod,
          relayUrl: "http://127.0.0.1:3001/auth/claim"
        });

        console.log('claimResp: ', claimResp)

        console.log("pkp public key: ", claimResp.pubkey);

        const data = {
          // hello world in Uint8Array
          toSign: [104, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100],
          publicKey: claimResp.pubkey,
          sigName: 'hello-world-sig',
        };

        let sig = await litNodeClient.pkpSign({
          toSign: data.toSign,
          pubKey: claimResp.pubkey,
          authMethods: [authMethod],
          authSig,
        });

        console.log("sig: ", sig);

        let msg = ethers.utils.arrayify('0x' + sig.dataSigned)
        const recoveredPk = ethers.utils.recoverPublicKey(msg, {r: '0x'+sig.r, s: '0x'+sig.s, v: sig.recid});
        console.log('recoveredPk: ', recoveredPk);

        const addr = ethers.utils.computeAddress('0x' + sig.publicKey);
        const recoveredAddr = ethers.utils.computeAddress(recoveredPk);
        const claimedAddr = ethers.utils.computeAddress("0x" + claimResp.pubkey);

        console.log('addr from sig public key: ', addr);
        console.log('recovered addr from sig: ', recoveredAddr);
        console.log('addr from claimed public key: ', claimedAddr);
      }

      

      var logout = async () => {
        const testName = 'Logout';
        document.getElementById('status').innerText = `Testing ${testName}...`;

        LitJsSdk.disconnectWeb3();

        document.getElementById(
          'status'
        ).innerText = `${testName}: Success - Logged out`;
      };

      document.addEventListener(
        'lit-ready',
        function (e) {
          console.log('LIT network is ready');
          document.getElementById('networkStatus').innerText =
            'Success!  Connected to Lit Protocol Network';
        },
        false
      );

      function isNodeStorageError(errorCode) {
        return (
          errorCode === 'storage_error' || errorCode === 'NodeStorageError'
        );
      }

      window.sendStytchOTP = sendStytchOTP;
      window.verifyAndClaimPKP = verifyAndClaimPKP;
      window.logout = logout;
    </script>
  </head>

  <body>
    <h1>Manual tests</h1>
    <br />
    <br />
    <div id="networkStatus">Connecting to Lit Protocol Network...</div>
    <br />
    <br />
    <input id="email" type="text" value="chris@litprotocol.com" />
    <button onclick="sendStytchOTP(document.getElementById('email').value)">Send Stytch OTP</button>
    <br />
    <br />
    <input id="otp" type="text" placeholder="OTP" />
    <button onclick="verifyAndClaimPKP(document.getElementById('otp').value)">Verify and Claim PKP</button>
    

    <button onclick="logout()">Logout</button>
    <br />
    <br />
    <h2 id="status"></h2>
    <br />
    <p id="humanized"></p>
  </body>
</html>