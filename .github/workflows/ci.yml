name: CI
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
      - staging/**
      - feat/**
      - feature/**
jobs:
  e2e-connection:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      NETWORK: cayenne
      DEBUG: true
      MAX_ATTEMPTS: 3
    steps:
      - name: Checkout Lit Actions
        uses: actions/checkout@v4
        id: checkout
        with: 
          fetch-depth: 0
          repository: LIT-Protocol/lit-assets
          token: ${{secrets.GH_PAT}}
          path: ${{ github.workspace }}/lit-assets/
          submodules: false
          sparse-checkout: .
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      - name: Install project dependencies
        run: yarn install
      - name: Build packages
        id: build
        run: yarn build:dev
      - name: Run End to End Tests
        if: steps.build.outputs.exit_code == 0
        run: yarn test:local --filter=testUseEoaSessionSigsToExecuteJsSigning,testUseEoaSessionSigsToPkpSign,testUsePkpSessionSigsToExecuteJsSigning,testUsePkpSessionSigsToPkpSign,testUseValidLitActionCodeGeneratedSessionSigsToPkpSign,testUseValidLitActionCodeGeneratedSessionSigsToExecuteJsSigning,testDelegatingCapacityCreditsNFTToAnotherWalletToExecuteJs,testEthAuthSigToEncryptDecryptString,testExecuteJsSignAndCombineEcdsa,testExecutJsDecryptAndCombine,testExecuteJsBroadcastAndCollect  --exclude=Parallel
    services:
      shiva:  
        image: ghcr.io/lit-protocol/shiva:latest
        ports:  
          - 8000:8000
          - 8545:8545
          - 7470:7470
          - 7471:7471
          - 7472:7472
          - 7473:7473
          - 7474:7474
          - 7475:7475
        volumes:
          - ${{github.workspace}}/lit-assets:/data
        env:
          HASH: 7a67a98c3648e0a4c38a210a084a5ca8bef577ae
          IPFS_API_KEY: ${{secrets.IPFS_API_KEY}}
          GH_PAT: ${{secrets.GH_PAT}}